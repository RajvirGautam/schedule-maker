<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAROHAN 2025 Schedule Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #0a0a2a 0%, #1a1a4a 50%, #2a2a6a 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #000428 0%, #004e92 50%, #2a9df4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #000428 0%, #004e92 50%, #2a9df4 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 4, 40, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 4, 40, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }
        
        .download-btn {
            display: block;
            margin: 20px auto;
            padding: 15px 40px;
            background: linear-gradient(135deg, #000428 0%, #004e92 50%, #2a9df4 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 4, 40, 0.4);
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 4, 40, 0.6);
        }
        
        .download-btn:active {
            transform: translateY(0);
        }
        
        #scheduleTable {
            background: white;
            padding: 20px;
            overflow-x: auto;
        }
        
        .day-section {
            margin-bottom: 40px;
        }
        
        .day-title {
            background: linear-gradient(135deg, #000428 0%, #004e92 50%, #2a9df4 100%);
            color: white;
            padding: 15px;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 800px;
        }
        
        th {
            background: linear-gradient(135deg, #000428 0%, #004e92 50%, #2a9df4 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #ddd;
            font-size: 0.9em;
            position: relative;
        }
        
        td {
            padding: 10px 8px;
            border: 1px solid #ddd;
            font-size: 0.85em;
            line-height: 1.4;
            position: relative;
            text-align: center;
            vertical-align: middle;
        }
        
        td.hidden-cell {
            display: none;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:nth-child(odd) {
            background-color: #ffffff;
        }
        
        tr:hover {
            background-color: #f0f0ff;
        }
        
        td:first-child {
            font-weight: bold;
            color: #004e92;
            white-space: nowrap;
        }
        
        .editable {
            outline: none;
            min-height: 20px;
        }
        
        .selected {
            background-color: rgba(0, 78, 146, 0.3) !important;
            border: 2px solid #004e92 !important;
        }
        
        .merge-selected {
            background-color: rgba(243, 156, 18, 0.3) !important;
            border: 2px solid #f39c12 !important;
        }
        
        .merged {
            background-color: rgba(46, 204, 113, 0.2);
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #004e92;
            margin-top: 10px;
        }
        
        .cell-controls {
            position: absolute;
            top: 2px;
            right: 2px;
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px;
            border-radius: 3px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            z-index: 10;
            pointer-events: auto;
        }
        
        td:hover .cell-controls, th:hover .cell-controls {
            display: block;
        }
        
        .cell-btn {
            background: #e74c3c;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            color: white;
            border-radius: 2px;
            pointer-events: auto;
        }
        
        .cell-btn:hover {
            background: #c0392b;
        }
        
        .merge-options {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .merge-options.show {
            display: block;
        }
        
        .merge-info {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-group {
                width: 100%;
                justify-content: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ AAROHAN 2025 ðŸš€</h1>
        <p class="subtitle">Complete TechFest Schedule Editor - October 10-12, 2025</p>
        
        <div class="controls">
            <div class="control-group">
                <button class="btn btn-success" id="addRowBtn">Add Row Below</button>
                <button class="btn btn-danger" id="deleteRowBtn">Delete Row</button>
                <button class="btn btn-success" id="addColumnBtn">Add Column Right</button>
                <button class="btn btn-danger" id="deleteColumnBtn">Delete Column</button>
            </div>
            <div class="control-group">
                <button class="btn btn-warning" id="mergeCellsBtn">Merge Cells</button>
                <button class="btn" id="splitCellsBtn">Split Cells</button>
                <button class="btn" id="clearSelectionBtn">Clear Selection</button>
                <button class="btn btn-info" id="undoBtn">â†¶ Undo</button>
            </div>
        </div>
        
        <button class="download-btn" onclick="downloadAsPDF()">ðŸ“¥ Download Schedule as PDF</button>
        <div class="loading" id="loading">Generating PDF, please wait...</div>
        
        <div id="scheduleTable">
            <!-- Tables will be generated here -->
        </div>
    </div>

    <div class="merge-options" id="mergeOptions">
        <p>Select cells to merge (Click to select multiple):</p>
        <div class="merge-info" id="mergeInfo">No cells selected</div>
        <div class="control-group">
            <button class="btn btn-success" id="mergeThemBtn">Merge Them</button>
            <button class="btn btn-danger" id="cancelMergeBtn">Cancel</button>
        </div>
    </div>

    <script>
        // Data structure for the schedule based on the PDF
        const scheduleData = {
            days: [
                {
                    title: "DAY 1 - 10th October 2025",
                    headers: ["Time", "PRARUPAM", "OPEN SCIENCE DAY", "INDUSTRY EXPO", "ROBORACE", "STUDENT CONFERENCE", "INVITED TALKS"],
                    rows: [
                        ["DAY 01", "", "", "", "", "", ""],
                        ["MORNING EVENTS", "", "", "", "", "", ""],
                        ["09:30 â€“ 11:00", "Registration & Kit Distribution", "", "", "", "", ""],
                        ["10:00 â€“ 11:00", "TRL 1, 2, 3", "Departmental Visits", "", "", "", ""],
                        ["10:15 â€“ 11:20", "Inaugural Session", "", "", "", "", ""],
                        ["10:15 â€“ 10:30", "Lamp Lighting", "", "", "", "", ""],
                        ["10:31 â€“ 10:41", "Address by Director", "", "", "", "", ""],
                        ["10:42 â€“ 11:07", "Keynote Talk: Journey from Idea to Prototype", "", "", "", "", ""],
                        ["11:08 â€“ 11:18", "Chief Guest Address", "", "", "", "", ""],
                        ["11:21 â€“ 11:41", "Tea / Coffee Networking (Guests Only)", "", "", "", "", ""],
                        ["11:30 â€“ 01:00", "Poster Display & Concept Presentations", "", "", "", "", ""],
                        ["11:00 â€“ 11:30", "", "", "Expo Inauguration", "", "", ""],
                        ["11:30 â€“ 06:00", "", "", "Industry Expo Showcase", "", "", ""],
                        ["11:00 â€“ 03:00", "", "", "", "Roborace & Other Games", "", ""],
                        ["01:00 â€“ 02:00", "Lunch Break (Jury: Dining Hall)", "", "", "", "", ""],
                        ["AFTERNOON SESSION", "", "", "", "", "", ""],
                        ["02:00 â€“ 03:30", "Prototype Demonstrations (Labs / Exhibition Area)", "", "", "", "", ""],
                        ["03:31 â€“ 03:50", "Expert Talk 1: Moving from TRL 1-3 to TRL 4-6", "", "", "", "", ""],
                        ["03:51 â€“ 04:10", "Expert Talk 2: Challenges in Translating Ideas into Prototypes", "", "", "", "", ""],
                        ["04:11 â€“ 04:20", "Announcements: Best Early-Stage Prototypes", "", "", "", "", ""],
                        ["04:21 â€“ 05:00", "Tea Break & Networking (For All)", "", "", "", "", ""],
                        ["10:00 â€“ 05:00", "", "Departmental Visits", "", "", "", ""]
                    ],
                    mergedCells: {}
                },
                {
                    title: "DAY 2 - 11th October 2025",
                    headers: ["Time", "PRARUPAM", "OPEN SCIENCE DAY", "INDUSTRY EXPO", "ROBORACE", "STUDENT CONFERENCE", "INVITED TALKS"],
                    rows: [
                        ["DAY 02", "", "", "", "", "", ""],
                        ["MORNING EVENTS", "", "", "", "", "", ""],
                        ["09:00 â€“ 09:00", "Entry Starts", "", "", "", "", ""],
                        ["09:00 â€“ 10:00", "Registration (New Entrants)", "", "", "", "Registration", ""],
                        ["09:30 â€“ 09:45", "Recap of Day 1 + Welcome to Day 2", "", "", "", "", ""],
                        ["09:45 â€“ 10:15", "Keynote Talk: Scaling Innovations", "", "", "", "", ""],
                        ["10:00 â€“ 10:15", "Inauguration (Investors Connect)", "", "", "", "", ""],
                        ["10:00 â€“ 10:45", "", "", "", "", "Inauguration (GJ)", ""],
                        ["10:00 â€“ 11:00", "", "", "", "", "Inauguration Ceremony", ""],
                        ["10:15 â€“ 10:30", "Address by Chairman, Institute Innovation Council", "", "", "", "", ""],
                        ["10:16 â€“ 10:26", "Address by Director", "", "", "", "", ""],
                        ["10:27 â€“ 10:37", "Address by CEO, SIF", "", "", "", "", ""],
                        ["10:30 â€“ 11:00", "Tea Break", "", "", "", "", ""],
                        ["10:38 â€“ 11:14", "Tea Break (Investors Connect)", "", "", "", "", ""],
                        ["10:00 â€“ 05:00", "TRL 4, 5, 6", "Departmental Visits", "", "", "", ""],
                        ["10:00 â€“ 06:00", "", "", "Industry Expo Showcase", "", "", ""],
                        ["11:00 â€“ 06:00", "", "", "Industry Expo Showcase (Basketball Ground)", "", "", ""],
                        ["11:00 â€“ 11:45", "", "", "", "", "High Tea (GJ)", ""],
                        ["11:00 â€“ 03:00", "", "", "", "Roborace & Other Games", "", ""],
                        ["11:15 â€“ 01:00", "Startup Pitching Sessions 1 & 2", "", "", "", "", ""],
                        ["11:30 â€“ 01:00", "Demonstrations of Functional Prototypes & Lab-Tested Models", "", "", "", "Plenary Sessions (LT)", "Plenary Sessions (LT)"],
                        ["01:00 â€“ 02:00", "Lunch Break", "", "", "", "Lunch Break & Networking (Experts)", ""],
                        ["AFTERNOON SESSION", "", "", "", "", "", ""],
                        ["02:01 â€“ 03:30", "Prototype Showcase (TRL 7-9)", "", "", "", "", ""],
                        ["02:01 â€“ 03:45", "Startup Pitching Sessions 3 & 4", "", "", "", "", ""],
                        ["02:00 â€“ 02:45", "", "", "", "", "IEEE Inauguration (LT)", ""],
                        ["02:00 â€“ 05:00", "", "", "", "", "IEEE Events + Student Conference", ""],
                        ["03:00 â€“ 05:00", "Panel Discussion: Startup Opportunities in Defence & Space-Tech", "", "", "", "", ""],
                        ["03:31 â€“ 04:30", "Panel Discussion: Startup Opportunities in Agri-Tech, Clean-Tech & Sustainability", "", "", "", "", ""],
                        ["03:46 â€“ 04:15", "Tea Break (Investors Connect)", "", "", "", "", ""],
                        ["03:30 â€“ 03:45", "", "", "", "", "Tea Break", ""],
                        ["04:00 â€“ 05:30", "One-on-One Interaction: Startups & Investors", "", "", "", "", ""],
                        ["04:31 â€“ 04:40", "Awards Announcements: Best TRL 4-6 & TRL 7-9 Prototypes", "", "", "", "", ""],
                        ["04:00 â€“ 05:00", "", "", "", "", "Awards and Vote of Thanks", ""],
                        ["04:41 â€“ 05:00", "Tea Break & Networking", "", "", "", "", ""]
                    ],
                    mergedCells: {}
                },
                {
                    title: "DAY 3 - 12th October 2025",
                    headers: ["Time", "PRARUPAM", "INDUSTRY EXPO", "ROBORACE", "STUDENT CONFERENCE", "CULTURAL EVENING", "INVITED TALKS"],
                    rows: [
                        ["DAY 03", "", "", "", "", "", ""],
                        ["MORNING EVENTS", "", "", "", "", "", ""],
                        ["10:00 â€“ 11:00", "", "", "", "Expert Talk (GJ)", "", ""],
                        ["10:00 â€“ 05:00", "TRL 7, 8, 9", "", "", "IEEE Student Conference (LT)", "", ""],
                        ["10:00 â€“ 06:00", "", "Industry Expo Showcase (Basketball Ground)", "", "", "", ""],
                        ["11:00 â€“ 02:00", "", "", "Roborace & Other Games", "", "", ""],
                        ["11:30 â€“ 01:00", "", "", "", "Oral Presentations - Student Conference (LT)", "", ""],
                        ["01:00 â€“ 02:00", "", "", "", "Lunch", "", ""],
                        ["AFTERNOON SESSION", "", "", "", "", "", ""],
                        ["02:00 â€“ 03:30", "", "", "", "IEEE Poster Presentation (Silveria)", "", ""],
                        ["03:30 â€“ 03:45", "", "", "", "Tea Break", "", ""],
                        ["04:00 â€“ 05:00", "Awards Ceremony: IEEE, Roborace, Prarupam", "", "", "Awards Ceremony: IEEE, Roborace, Prarupam", "", ""],
                        ["05:00 â€“ 08:00", "", "", "", "", "Cultural Evening (Cricket Ground)", ""]
                    ],
                    mergedCells: {}
                }
            ]
        };

        // State management
        let selectedCells = [];
        let mergeMode = false;
        let cellsToMerge = [];
        let currentDayIndex = 0;
        let currentTable = null;
        let historyStack = [];
        let maxHistorySize = 50;

        // Save current state to history
        function saveState() {
            const currentState = JSON.parse(JSON.stringify(scheduleData));
            historyStack.push(currentState);
            
            // Limit history size
            if (historyStack.length > maxHistorySize) {
                historyStack.shift();
            }
            
            // Update undo button state
            updateUndoButton();
        }

        // Undo last action
        function undo() {
            if (historyStack.length === 0) {
                alert('Nothing to undo!');
                return;
            }
            
            // Restore previous state
            const previousState = historyStack.pop();
            
            // Deep copy the previous state back
            scheduleData.days = JSON.parse(JSON.stringify(previousState.days));
            
            // Re-render
            initEditor();
            
            // Update undo button state
            updateUndoButton();
        }

        // Update undo button appearance
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                if (historyStack.length === 0) {
                    undoBtn.disabled = true;
                    undoBtn.style.opacity = '0.5';
                    undoBtn.style.cursor = 'not-allowed';
                } else {
                    undoBtn.disabled = false;
                    undoBtn.style.opacity = '1';
                    undoBtn.style.cursor = 'pointer';
                }
            }
        }

        // Initialize the editor
        function initEditor() {
            const scheduleTable = document.getElementById('scheduleTable');
            scheduleTable.innerHTML = '';
            
            scheduleData.days.forEach((day, dayIndex) => {
                const daySection = document.createElement('div');
                daySection.className = 'day-section';
                
                const dayTitle = document.createElement('div');
                dayTitle.className = 'day-title';
                dayTitle.textContent = day.title;
                daySection.appendChild(dayTitle);
                
                const table = document.createElement('table');
                table.dataset.dayIndex = dayIndex;
                
                // Create header row
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                day.headers.forEach((header, colIndex) => {
                    const th = document.createElement('th');
                    th.dataset.colIndex = colIndex;
                    
                    // Create a text container to avoid clicking on controls
                    const textContainer = document.createElement('div');
                    textContainer.contentEditable = true;
                    textContainer.textContent = header;
                    textContainer.style.cssText = 'outline: none; width: 100%; min-height: 20px;';
                    
                    // Prevent the header itself from being editable
                    th.contentEditable = false;
                    
                    // Handle text updates
                    textContainer.addEventListener('input', function() {
                        // Save state before making changes
                        if (!textContainer.dataset.statesSaved) {
                            saveState();
                            textContainer.dataset.statesSaved = 'true';
                            // Reset flag after a short delay
                            setTimeout(() => {
                                textContainer.dataset.statesSaved = '';
                            }, 1000);
                        }
                        day.headers[colIndex] = this.textContent;
                    });
                    
                    // Add cell controls
                    const cellControls = document.createElement('div');
                    cellControls.className = 'cell-controls';
                    cellControls.innerHTML = '<button class="cell-btn" onclick="deleteColumn(' + colIndex + ', ' + dayIndex + ')">âœ•</button>';
                    th.appendChild(cellControls);
                    
                    th.appendChild(textContainer);
                    
                    th.addEventListener('click', (e) => {
                        if (e.target === th || e.target === textContainer) {
                            handleCellClick(th, dayIndex);
                        }
                    });
                    
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                
                day.rows.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    
                    row.forEach((cell, colIndex) => {
                        // Check if this cell is hidden due to a merge
                        const cellKey = `${rowIndex}-${colIndex}`;
                        if (day.mergedCells[cellKey] && day.mergedCells[cellKey].hidden) {
                            return; // Skip hidden cells
                        }
                        
                        const td = document.createElement('td');
                        td.className = 'editable';
                        td.contentEditable = true;
                        td.dataset.rowIndex = rowIndex;
                        td.dataset.colIndex = colIndex;
                        td.dataset.dayIndex = dayIndex;
                        
                        // Check if this cell is the main cell of a merge
                        if (day.mergedCells[cellKey]) {
                            const merge = day.mergedCells[cellKey];
                            if (merge.rowspan) td.rowSpan = merge.rowspan;
                            if (merge.colspan) td.colSpan = merge.colspan;
                            td.classList.add('merged');
                        }
                        
                        // Create a text container to avoid clicking on controls
                        const textContainer = document.createElement('div');
                        textContainer.contentEditable = true;
                        textContainer.textContent = cell;
                        textContainer.style.cssText = 'outline: none; width: 100%; height: 100%; min-height: 20px;';
                        
                        // Prevent the cell itself from being editable
                        td.contentEditable = false;
                        
                        // Handle text updates
                        textContainer.addEventListener('input', function() {
                            // Save state before making changes
                            if (!textContainer.dataset.statesSaved) {
                                saveState();
                                textContainer.dataset.statesSaved = 'true';
                                // Reset flag after a short delay
                                setTimeout(() => {
                                    textContainer.dataset.statesSaved = '';
                                }, 1000);
                            }
                            day.rows[rowIndex][colIndex] = this.textContent;
                        });
                        
                        // Check if this cell should be highlighted for merging
                        if (mergeMode) {
                            const isSelected = cellsToMerge.some(cellCoord => 
                                cellCoord.dayIndex === dayIndex && 
                                cellCoord.rowIndex === rowIndex && 
                                cellCoord.colIndex === colIndex
                            );
                            if (isSelected) {
                                td.classList.add('merge-selected');
                            }
                        }
                        
                        // Add cell controls
                        const cellControls = document.createElement('div');
                        cellControls.className = 'cell-controls';
                        cellControls.innerHTML = '<button class="cell-btn" onclick="deleteRow(' + rowIndex + ', ' + dayIndex + ')">âœ•</button>';
                        td.appendChild(cellControls);
                        
                        td.appendChild(textContainer);
                        
                        td.addEventListener('click', (e) => {
                            if (e.target === td || e.target === textContainer) {
                                handleCellClick(td, dayIndex);
                            }
                        });
                        
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
                
                table.appendChild(tbody);
                daySection.appendChild(table);
                scheduleTable.appendChild(daySection);
            });
            
            // Set current table reference
            currentTable = document.querySelector('table');
            currentDayIndex = 0;
            
            // Add event listeners for buttons
            setupEventListeners();
        }

        // Set up event listeners for control buttons
        function setupEventListeners() {
            document.getElementById('addRowBtn').addEventListener('click', addRowBelow);
            document.getElementById('deleteRowBtn').addEventListener('click', deleteSelectedRow);
            document.getElementById('addColumnBtn').addEventListener('click', addColumnRight);
            document.getElementById('deleteColumnBtn').addEventListener('click', deleteSelectedColumn);
            document.getElementById('mergeCellsBtn').addEventListener('click', startMergeMode);
            document.getElementById('splitCellsBtn').addEventListener('click', splitCells);
            document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);
            document.getElementById('mergeThemBtn').addEventListener('click', performMerge);
            document.getElementById('cancelMergeBtn').addEventListener('click', cancelMerge);
            document.getElementById('undoBtn').addEventListener('click', undo);
            
            // Update undo button state on load
            updateUndoButton();
        }

        // Handle cell click
        function handleCellClick(cell, dayIndex) {
            if (mergeMode) {
                // In merge mode, select cells for merging
                selectForMerge(cell, dayIndex);
            } else {
                // Normal selection mode
                selectCell(cell, dayIndex);
            }
        }

        // Select a cell for normal operations
        function selectCell(cell, dayIndex) {
            // Clear previous selection if not holding Ctrl key
            if (!event.ctrlKey) {
                clearSelection();
            }
            
            cell.classList.add('selected');
            selectedCells.push({
                element: cell,
                dayIndex: dayIndex,
                rowIndex: parseInt(cell.dataset.rowIndex) || 0,
                colIndex: parseInt(cell.dataset.colIndex)
            });
            
            currentDayIndex = dayIndex;
            currentTable = cell.closest('table');
        }

        // Select a cell for merging
        function selectForMerge(cell, dayIndex) {
            const rowIndex = parseInt(cell.dataset.rowIndex) || 0;
            const colIndex = parseInt(cell.dataset.colIndex);
            
            // Check if cell is already selected for merging
            const isAlreadySelected = cellsToMerge.some(cellCoord => 
                cellCoord.dayIndex === dayIndex && 
                cellCoord.rowIndex === rowIndex && 
                cellCoord.colIndex === colIndex
            );
            
            if (isAlreadySelected) {
                // Deselect the cell
                cell.classList.remove('merge-selected');
                cellsToMerge = cellsToMerge.filter(cellCoord => 
                    !(cellCoord.dayIndex === dayIndex && 
                      cellCoord.rowIndex === rowIndex && 
                      cellCoord.colIndex === colIndex)
                );
            } else {
                // Select the cell
                cell.classList.add('merge-selected');
                cellsToMerge.push({
                    dayIndex: dayIndex,
                    rowIndex: rowIndex,
                    colIndex: colIndex
                });
            }
            
            updateMergeInfo();
        }

        // Update merge information display
        function updateMergeInfo() {
            const mergeInfo = document.getElementById('mergeInfo');
            if (cellsToMerge.length === 0) {
                mergeInfo.textContent = 'No cells selected';
            } else {
                mergeInfo.textContent = `${cellsToMerge.length} cell(s) selected for merging`;
            }
        }

        // Start merge mode
        function startMergeMode() {
            mergeMode = true;
            clearSelection();
            cellsToMerge = [];
            
            // Show merge options
            const mergeOptions = document.getElementById('mergeOptions');
            mergeOptions.classList.add('show');
            
            // Update instructions
            updateMergeInfo();
            
            // Change button text to indicate merge mode
            document.getElementById('mergeCellsBtn').textContent = 'Merge Mode Active';
            document.getElementById('mergeCellsBtn').classList.add('btn-info');
        }

        // Cancel merge mode
        function cancelMerge() {
            mergeMode = false;
            cellsToMerge = [];
            
            // Re-render to remove merge highlights
            initEditor();
            
            // Hide merge options
            hideMergeOptions();
            
            // Reset button
            document.getElementById('mergeCellsBtn').textContent = 'Merge Cells';
            document.getElementById('mergeCellsBtn').classList.remove('btn-info');
        }

        // Hide merge options
        function hideMergeOptions() {
            document.getElementById('mergeOptions').classList.remove('show');
        }

        // Perform the actual merge
        function performMerge() {
            if (cellsToMerge.length < 2) {
                alert('Please select at least 2 cells to merge.');
                return;
            }
            
            // Save state before merging
            saveState();
            
            // Group cells by day
            const cellsByDay = {};
            cellsToMerge.forEach(cellCoord => {
                if (!cellsByDay[cellCoord.dayIndex]) {
                    cellsByDay[cellCoord.dayIndex] = [];
                }
                cellsByDay[cellCoord.dayIndex].push(cellCoord);
            });
            
            // Merge cells for each day
            Object.keys(cellsByDay).forEach(dayIndex => {
                const dayCells = cellsByDay[dayIndex];
                const dayData = scheduleData.days[dayIndex];
                
                // Sort cells by row and column
                dayCells.sort((a, b) => {
                    if (a.rowIndex !== b.rowIndex) {
                        return a.rowIndex - b.rowIndex;
                    }
                    return a.colIndex - b.colIndex;
                });
                
                // Calculate the span
                const minRow = Math.min(...dayCells.map(c => c.rowIndex));
                const maxRow = Math.max(...dayCells.map(c => c.rowIndex));
                const minCol = Math.min(...dayCells.map(c => c.colIndex));
                const maxCol = Math.max(...dayCells.map(c => c.colIndex));
                
                const rowspan = maxRow - minRow + 1;
                const colspan = maxCol - minCol + 1;
                
                // Collect content from all selected cells
                let mergedContent = '';
                dayCells.forEach((cellCoord) => {
                    const cellContent = dayData.rows[cellCoord.rowIndex][cellCoord.colIndex];
                    if (cellContent && cellContent.trim() !== '') {
                        if (mergedContent !== '') mergedContent += ' | ';
                        mergedContent += cellContent;
                    }
                });
                
                // If no content was found, use a default message
                if (mergedContent === '') {
                    mergedContent = 'Merged Cell';
                }
                
                // Update the first cell with merged content and span info
                const firstCellKey = `${minRow}-${minCol}`;
                dayData.rows[minRow][minCol] = mergedContent;
                
                // Store merge information
                dayData.mergedCells[firstCellKey] = {
                    rowspan: rowspan,
                    colspan: colspan
                };
                
                // Mark other cells as hidden
                for (let r = minRow; r <= maxRow; r++) {
                    for (let c = minCol; c <= maxCol; c++) {
                        if (r !== minRow || c !== minCol) {
                            const cellKey = `${r}-${c}`;
                            dayData.mergedCells[cellKey] = { hidden: true };
                            // Clear the content
                            dayData.rows[r][c] = '';
                        }
                    }
                }
            });
            
            // Exit merge mode and re-render
            cancelMerge();
            
            alert('Cells merged successfully!');
        }

        // Split merged cells
        function splitCells() {
            if (selectedCells.length === 0) {
                alert('Please select a merged cell to split.');
                return;
            }
            
            // Save state before splitting
            saveState();
            
            const selectedCell = selectedCells[0];
            const dayIndex = selectedCell.dayIndex;
            const rowIndex = selectedCell.rowIndex;
            const colIndex = selectedCell.colIndex;
            const dayData = scheduleData.days[dayIndex];
            
            const cellKey = `${rowIndex}-${colIndex}`;
            
            if (!dayData.mergedCells[cellKey] || dayData.mergedCells[cellKey].hidden) {
                alert('Selected cell is not a merged cell.');
                return;
            }
            
            const merge = dayData.mergedCells[cellKey];
            const rowspan = merge.rowspan || 1;
            const colspan = merge.colspan || 1;
            
            // Remove merge information for all affected cells
            for (let r = rowIndex; r < rowIndex + rowspan; r++) {
                for (let c = colIndex; c < colIndex + colspan; c++) {
                    const key = `${r}-${c}`;
                    delete dayData.mergedCells[key];
                }
            }
            
            // Re-render
            initEditor();
            alert('Cell split successfully!');
        }

        // Clear selection
        function clearSelection() {
            selectedCells.forEach(cell => {
                cell.element.classList.remove('selected');
            });
            selectedCells = [];
        }

        // Add a new row below the selected cell
        function addRowBelow() {
            if (selectedCells.length === 0) {
                alert('Please select a cell to add a row below.');
                return;
            }
            
            // Save state before adding row
            saveState();
            
            const selectedCell = selectedCells[0];
            const dayIndex = selectedCell.dayIndex;
            const rowIndex = selectedCell.rowIndex;
            const dayData = scheduleData.days[dayIndex];
            
            // Create new row in data
            const newRow = Array(dayData.headers.length).fill('');
            dayData.rows.splice(rowIndex + 1, 0, newRow);
            
            // Re-render the table
            initEditor();
        }

        // Delete selected row
        function deleteSelectedRow() {
            if (selectedCells.length === 0) return;
            
            // Save state before deleting
            saveState();
            
            const dayIndex = selectedCells[0].dayIndex;
            const rowIndex = selectedCells[0].rowIndex;
            
            deleteRow(rowIndex, dayIndex);
            clearSelection();
        }

        // Delete a specific row
        function deleteRow(rowIndex, dayIndex) {
            const dayData = scheduleData.days[dayIndex];
            
            // Remove from data
            dayData.rows.splice(rowIndex, 1);
            
            // Re-render the table
            initEditor();
        }

        // Add a new column to the right of the selected cell
        function addColumnRight() {
            if (selectedCells.length === 0) {
                alert('Please select a cell to add a column to the right.');
                return;
            }
            
            // Save state before adding column
            saveState();
            
            const selectedCell = selectedCells[0];
            const dayIndex = selectedCell.dayIndex;
            const colIndex = selectedCell.colIndex;
            const dayData = scheduleData.days[dayIndex];
            
            // Add to headers
            dayData.headers.splice(colIndex + 1, 0, 'New Column');
            
            // Add to each row
            dayData.rows.forEach(row => {
                row.splice(colIndex + 1, 0, '');
            });
            
            // Re-render the table
            initEditor();
        }

        // Delete selected column
        function deleteSelectedColumn() {
            if (selectedCells.length === 0) return;
            
            // Save state before deleting
            saveState();
            
            const dayIndex = selectedCells[0].dayIndex;
            const colIndex = selectedCells[0].colIndex;
            
            deleteColumn(colIndex, dayIndex);
            clearSelection();
        }

        // Delete a specific column
        function deleteColumn(colIndex, dayIndex) {
            const dayData = scheduleData.days[dayIndex];
            
            // Remove from headers
            dayData.headers.splice(colIndex, 1);
            
            // Remove from each row
            dayData.rows.forEach(row => {
                row.splice(colIndex, 1);
            });
            
            // Re-render the table
            initEditor();
        }

        // Download table as PDF
        function downloadAsPDF() {
            const button = document.querySelector('.download-btn');
            const loading = document.getElementById('loading');
            
            button.disabled = true;
            button.textContent = 'Generating...';
            loading.style.display = 'block';
            
            const element = document.getElementById('scheduleTable');
            
            html2canvas(element, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('AAROHAN_2025_Schedule.pdf');
                
                button.disabled = false;
                button.textContent = 'ðŸ“¥ Download Schedule as PDF';
                loading.style.display = 'none';
            }).catch(err => {
                console.error('Error generating PDF:', err);
                alert('Error generating PDF. Please try again.');
                button.disabled = false;
                button.textContent = 'ðŸ“¥ Download Schedule as PDF';
                loading.style.display = 'none';
            });
        }

        // Initialize the editor when the page loads
        document.addEventListener('DOMContentLoaded', initEditor);
    </script>
</body>
</html>
